# ðŸš€ amoCRM/Kommo PHP API (v4) Client

ÐŸÐ¾Ð´Ð´ÐµÑ€Ð¶Ð¸Ð²Ð°ÐµÑ‚ OAuth 2.0, ÐºÑÑˆÐ¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ðµ, Ð¿Ð°Ð³Ð¸Ð½Ð°Ñ†Ð¸ÑŽ, ÑÐ¾Ð±Ñ‹Ñ‚Ð¸Ñ, Ð°Ð²Ñ‚Ð¾Ð¼Ð°Ñ‚Ð¸Ñ‡ÐµÑÐºÐ¾Ðµ Ð¾Ð±Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ðµ Ñ‚Ð¾ÐºÐµÐ½Ð¾Ð², Ð¾Ð±Ñ€Ð°Ð±Ð¾Ñ‚ÐºÑƒ Ð¾ÑˆÐ¸Ð±Ð¾Ðº Ð¸ Ñ€Ð°Ð±Ð¾Ñ‚Ñƒ Ñ Ð»ÑŽÐ±Ñ‹Ð¼Ð¸ ÑÑƒÑ‰Ð½Ð¾ÑÑ‚ÑÐ¼Ð¸ (ÑÐ´ÐµÐ»ÐºÐ¸, ÐºÐ¾Ð½Ñ‚Ð°ÐºÑ‚Ñ‹, ÐºÐ¾Ð¼Ð¿Ð°Ð½Ð¸Ð¸, Ð·Ð°Ð´Ð°Ñ‡Ð¸, Ð·Ð°Ð¼ÐµÑ‚ÐºÐ¸ Ð¸ Ð´Ñ€.).

---

## âœ… Ð’Ð¾Ð·Ð¼Ð¾Ð¶Ð½Ð¾ÑÑ‚Ð¸

- âœ… ÐŸÐ´Ð´ÐµÑ€Ð¶ÐºÐ° [amoCRM/Kommo API v4](https://www.amocrm.ru/developers/content/crm_platform/platform-abilities)
- âœ… OAuth 2.0 Ñ Ð°Ð²Ñ‚Ð¾Ð¾Ð±Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸ÐµÐ¼ Ñ‚Ð¾ÐºÐµÐ½Ð¾Ð²
- âœ… Ð¥Ñ€Ð°Ð½Ð¸Ð»Ð¸Ñ‰Ðµ Ñ‚Ð¾ÐºÐµÐ½Ð¾Ð²: Ñ„Ð°Ð¹Ð»Ñ‹, Redis, MongoDB + Ð´Ð¾Ð»Ð³Ð¾ÑÑ€Ð¾Ñ‡Ð½Ñ‹Ðµ Ñ‚Ð¾ÐºÐµÐ½Ñ‹
- âœ… ÐšÑÑˆÐ¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ðµ ÑÐ¿Ñ€Ð°Ð²Ð¾Ñ‡Ð½Ð¸ÐºÐ¾Ð² Ð² Ñ„Ð°Ð¹Ð»Ð°Ñ… Ð¸ Redis: Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»Ð¸, Ð¿Ð¾Ð»Ñ, Ñ‚Ð¸Ð¿Ñ‹ Ð·Ð°Ð´Ð°Ñ‡ Ð¸ Ñ‚.Ð´.
- âœ… ÐŸÐ¾ÑÑ‚Ñ€Ð°Ð½Ð¸Ñ‡Ð½Ð¾Ðµ Ð¸Ð·Ð²Ð»ÐµÑ‡ÐµÐ½Ð¸Ðµ ÑÑƒÑ‰Ð½Ð¾ÑÑ‚ÐµÐ¹ Ñ‡ÐµÑ€ÐµÐ· `foreach` Ð¸ `do-while`
- âœ… ÐžÐ±Ñ€Ð°Ð±Ð¾Ñ‚ÐºÐ° ÑÐ¾Ð±Ñ‹Ñ‚Ð¸Ð¹ Ñ‡ÐµÑ€ÐµÐ· `callbacks`: Ð¾Ñ‚Ð»Ð°Ð´ÐºÐ°, ÐºÐ¾Ð½Ñ‚Ñ€Ð¾Ð»ÑŒ
- âœ… ÐžÐ³Ñ€Ð°Ð½Ð¸Ñ‡ÐµÐ½Ð¸Ðµ Ñ‡Ð°ÑÑ‚Ð¾Ñ‚Ñ‹ Ð·Ð°Ð¿Ñ€Ð¾ÑÐ¾Ð²
- âœ… ÐŸÐ¾Ð´Ð´ÐµÑ€Ð¶ÐºÐ° Ð¼Ð°ÑÑÐ¾Ð²Ñ‹Ñ… Ð¾Ð¿ÐµÑ€Ð°Ñ†Ð¸Ð¹
- âœ… ÐœÑƒÐ»ÑŒÑ‚Ð¸Ð°ÐºÐºÐ°ÑƒÐ½Ñ‚Ð½Ð¾ÑÑ‚ÑŒ

---

## ðŸ“¦ Ð£ÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ°

```bash
composer require ufee/amoapi-v4
```

## âš™ï¸ Ð‘Ñ‹ÑÑ‚Ñ€Ñ‹Ð¹ ÑÑ‚Ð°Ñ€Ñ‚
```php
$api = \Ufee\AmoV4\ApiClient::setInstance([...]);
$leads = $api->leads()->get();
foreach ($leads as $lead) {
    echo $lead->name . "\n";
}
```

### ÐžÐ¿Ñ€ÐµÐ´ÐµÐ»ÐµÐ½Ð¸Ðµ ÐºÐ»Ð¸ÐµÐ½Ñ‚Ð°  
```php
$api = \Ufee\AmoV4\ApiClient::setInstance([
    'domain'        => 'yourdomain',           // Ð´Ð¾Ð¼ÐµÐ½ (Ð±ÐµÐ· .amocrm.ru)
    'client_id'     => '8a8135d4-31ca-47...', // ID Ð¸Ð½Ñ‚ÐµÐ³Ñ€Ð°Ñ†Ð¸Ð¸
    'client_secret' => 'zMZFNnho8FozhrDzxrbA9xuR9...',
    'redirect_uri'  => 'https://yoursite.com/auth/callback',
    'zone'          => 'ru', // Ð¸Ð»Ð¸ 'com' Ð´Ð»Ñ Kommo
]);
```

### ÐÐ°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ° Ð¿Ð°Ñ€Ð°Ð¼ÐµÑ‚Ñ€Ð¾Ð² (Ð¾Ð¿Ñ†Ð¸Ð¾Ð½Ð°Ð»ÑŒÐ½Ð¾)  
```php
$api->setParam('query_delay', 0.15);   // Ð·Ð°Ð´ÐµÑ€Ð¶ÐºÐ° Ð¼ÐµÐ¶Ð´Ñƒ Ð·Ð°Ð¿Ñ€Ð¾ÑÐ°Ð¼Ð¸ (ÑÐµÐº)
$api->setParam('query_retries', 3);    // ÐºÐ¾Ð»-Ð²Ð¾ Ð¿Ð¾Ð¿Ñ‹Ñ‚Ð¾Ðº Ð¿Ñ€Ð¸ Ð¾ÑˆÐ¸Ð±ÐºÐ°Ñ… 429
$api->setParam('lang', 'ru');          // ÑÐ·Ñ‹Ðº Ð°ÐºÐºÐ°ÑƒÐ½Ñ‚Ð°
```

### Ð¥Ñ€Ð°Ð½Ð¸Ð»Ð¸Ñ‰Ðµ Oauth 
Ð¤Ð°Ð¹Ð»Ð¾Ð²Ð¾Ðµ Ñ…Ñ€Ð°Ð½ÐµÐ½Ð¸Ðµ OAuth-Ñ‚Ð¾ÐºÐµÐ½Ð¾Ð²  
Ð˜ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐµÑ‚ÑÑ Ð¿Ð¾ ÑƒÐ¼Ð¾Ð»Ñ‡Ð°Ð½Ð¸ÑŽ: /src/Temp/{domain}/{client_id}.json
```php
$api->oauth->setStorageFiles('/path/to/oauth/storage');
```
**Ð”Ð¾Ð»Ð³Ð¾ÑÑ€Ð¾Ñ‡Ð½Ñ‹Ð¹ Ñ‚Ð¾ÐºÐµÐ½**  
```php
$api->oauth->setLongToken($long_token);
```
**Redis**  
ÐŸÐ¾Ð´Ð´ÐµÑ€Ð¶Ð¸Ð²Ð°ÐµÑ‚ÑÑ Ð±Ð¸Ð±Ð»Ð¸Ð¾Ñ‚ÐµÐºÐ° [phpredis](https://github.com/phpredis/phpredis)
```php
$redis = new \Redis();
$redis->connect('127.0.0.1');
$redis->setOption(\Redis::OPT_SERIALIZER, \Redis::SERIALIZER_PHP); // Ð¸Ð»Ð¸ \Redis::SERIALIZER_IGBINARY
$redis->select(4);

$api->oauth->setStorageRedis($redis);
```
**Mongodb**  
ÐŸÐ¾Ð´Ð´ÐµÑ€Ð¶Ð¸Ð²Ð°ÐµÑ‚ÑÑ Ð±Ð¸Ð±Ð»Ð¸Ð¾Ñ‚ÐµÐºÐ° [mongo-php-library](https://github.com/mongodb/mongo-php-library)
```php
$mongo = new \MongoDB\Client('mongodb://127.0.0.1');
$collection = $mongo->selectCollection('amo', 'oauth');

$api->oauth->setStorageMongo($mongo);
```

### ÐšÐµÑˆÐ¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ðµ Ð´Ð°Ð½Ð½Ñ‹Ñ…  
ÐŸÐ¾Ð´Ð´ÐµÑ€Ð¶Ð¸Ð²Ð°ÐµÑ‚ÑÑ ÐºÐµÑˆÐ¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ðµ ÑÐ¿Ñ€Ð°Ð²Ð¾Ñ‡Ð½Ð¸ÐºÐ¾Ð² Ð¸ Ð¾Ð±Ñ‰Ð¸Ñ… Ð´Ð°Ð½Ð½Ñ‹Ñ… Ð°ÐºÐºÐ°ÑƒÐ½Ñ‚Ð°  
Ð’Ñ€ÐµÐ¼Ñ Ð¶Ð¸Ð·Ð½Ð¸ Ð´Ð»Ñ ÐºÑÑˆÐ° / Ð¿Ð¾ ÑƒÐ¼Ð¾Ð»Ñ‡Ð°Ð½Ð¸ÑŽ
```php
$api->cache->setTtl([
    'account'      => 60, // 3600
    'users'        => 60, // 1800
    'pipelines'    => 60, // 3600
    'userGroups'   => 60, // 3600
    'customFields' => 60, // 1800
    'taskTypes'    => 60, // 3600
    'eventTypes'   => 60  // 86400
]);
```
Ð¤Ð°Ð¹Ð»Ð¾Ð²Ð¾Ðµ Ñ…Ñ€Ð°Ð½ÐµÐ½Ð¸Ðµ OAuth-Ñ‚Ð¾ÐºÐµÐ½Ð¾Ð²  
Ð˜ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐµÑ‚ÑÑ Ð¿Ð¾ ÑƒÐ¼Ð¾Ð»Ñ‡Ð°Ð½Ð¸ÑŽ: /src/Temp/{domain}/{client_id}.{key}.cache
```php
$api->cache->setStorageFiles('/path/to/cache/storage', [
    'serialize'   => 'igbinary_serialize', // Ñ€ÐµÐºÐ¾Ð¼ÐµÐ½Ð´ÑƒÐµÑ‚ÑÑ Ð²Ð¼ÐµÑÑ‚Ð¾ serialize
    'unserialize' => 'igbinary_unserialize' // Ñ€ÐµÐºÐ¾Ð¼ÐµÐ½Ð´ÑƒÐµÑ‚ÑÑ Ð²Ð¼ÐµÑÑ‚Ð¾ unserialize
]);
```
**Redis**  
ÐŸÐ¾Ð´Ð´ÐµÑ€Ð¶Ð¸Ð²Ð°ÐµÑ‚ÑÑ Ð±Ð¸Ð±Ð»Ð¸Ð¾Ñ‚ÐµÐºÐ° [phpredis](https://github.com/phpredis/phpredis)
```php
$redis = new \Redis();
redis->connect('127.0.0.1');
$redis->setOption(\Redis::OPT_SERIALIZER, \Redis::SERIALIZER_PHP); // Ð¸Ð»Ð¸ \Redis::SERIALIZER_IGBINARY
$redis->select(4);

$api->cache->setStorageRedis($redis);
```

### ðŸ”” Ð¡Ð¾Ð±Ñ‹Ñ‚Ð¸Ñ (Callbacks)  
ÐœÐ¾Ð½Ð¸Ñ‚Ð¾Ñ€Ð¸Ð½Ð³ Ð·Ð°Ð¿Ñ€Ð¾ÑÐ¾Ð², Ð»Ð¾Ð³Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ðµ, Ð¾Ð±Ñ€Ð°Ð±Ð¾Ñ‚ÐºÐ° Ð¾ÑˆÐ¸Ð±Ð¾Ðº, ÐºÐ¾Ð½Ñ‚Ñ€Ð¾Ð»ÑŒ  
```php
$api->callbacks->on($event, function($payload) {
   // Ð¿Ð¾Ð´Ð¿Ð¸ÑÐºÐ° Ð½Ð° ÑÐ¾Ð±Ñ‹Ñ‚Ð¸Ñ
});
```
```php
$api->callbacks->off($event, function($payload) {
   // Ð¾Ñ‚Ð¿Ð¸ÑÐºÐ° Ð¾Ñ‚ ÑÐ¾Ð±Ñ‹Ñ‚Ð¸Ð¹
});
```
ÐŸÐ¾Ð´Ð´ÐµÑ€Ð¶Ð¸Ð²Ð°ÐµÐ¼Ñ‹Ðµ ÑÐ¾Ð±Ñ‹Ñ‚Ð¸Ñ  
Ð¡Ð¾Ð±Ñ‹Ñ‚Ð¸Ñ Ð¿Ð¾ query Ð²Ñ‹Ð¿Ð¾Ð»Ð½ÑÑŽÑ‚ÑÑ Ð² Ð¿Ð¾ÑÐ»ÐµÐ´Ð¾Ð²Ð°Ñ‚ÐµÐ»ÑŒÐ½Ð¾ÑÑ‚Ð¸, ÑƒÐºÐ°Ð·Ð°Ð½Ð½Ð¾Ð¹ Ð½Ð¸Ð¶Ðµ
```php
$api->callbacks->off('query.delay')->on('query.delay', function($query) {
    // Ð¿Ð¾ ÑƒÐ¼Ð¾Ð»Ñ‡Ð°Ð½Ð¸ÑŽ Ð¿Ñ€Ð¾Ð¿Ð¸ÑÐ°Ð½Ð° Ð»Ð¾Ð³Ð¸ÐºÐ° Ð·Ð°Ð´ÐµÑ€Ð¶ÐµÐº Ð½Ð° Ð¾ÑÐ½Ð¾Ð²Ðµ $query->instance->getParam('query_delay')
    // Ð¿Ð°ÑƒÐ·Ð° Ð¼ÐµÐ¶Ð´Ñƒ Ð·Ð°Ð¿Ñ€Ð¾ÑÐ°Ð¼Ð¸ Ð²Ñ‹Ñ‡Ð¸ÑÐ»ÑÐµÑ‚ÑÑ Ð°Ð²Ñ‚Ð¾Ð¼Ð°Ñ‚Ð¸Ñ‡ÐµÑÐºÐ¸
    sleep(1); // ÐºÐ°ÑÑ‚Ð¾Ð¼Ð½Ð°Ñ Ð»Ð¾Ð³Ð¸ÐºÐ° Ð·Ð°Ð´ÐµÑ€Ð¶ÐµÐº Ð¼ÐµÐ¶Ð´Ñƒ Ð·Ð°Ð¿Ñ€Ð¾ÑÐ°Ð¼Ð¸
});

$api->callbacks->on('query.request.before', function($query) {
    // Ð²Ñ‹Ð·Ñ‹Ð²Ð°ÐµÑ‚ÑÑ Ð¿ÐµÑ€ÐµÐ´ Ð²Ñ‹Ð¿Ð¾Ð»Ð½ÐµÐ½Ð¸ÐµÐ¼ Ð·Ð°Ð¿Ñ€Ð¾ÑÐ°
    echo '['.$query->method.'] '.$query->getUrl();
});

$api->callbacks->on('query.response.code', function($code, $query) {
    // Ð²Ñ‹Ð·Ñ‹Ð²Ð°ÐµÑ‚ÑÑ Ð¿Ð¾ÑÐ»Ðµ Ð²Ñ‹Ð¿Ð¾Ð»Ð½ÐµÐ½Ð¸Ñ Ð·Ð°Ð¿Ñ€Ð¾ÑÐ°
    // Ð¿Ð¾ÑƒÐ¼Ð¾Ð»Ñ‡Ð°Ð½Ð¸ÑŽ Ð¿Ñ€Ð¸ÑÑƒÑ‚ÑÑ‚Ð²ÑƒÐµÑ‚ Ð¾Ð±Ñ€Ð°Ð±Ð¾Ñ‚ÐºÐ° ÐºÐ¾Ð´Ð¾Ð²:
    // 429 - Ð¿Ð¾Ð²Ñ‚Ð¾Ñ€Ð½Ñ‹Ðµ Ð¿Ð¾Ð¿Ñ‹Ñ‚ÐºÐ¸
    // 401 - Ð¿Ð¾Ð²Ñ‚Ð¾Ñ€Ð½Ð°Ñ Ð¿Ð¾Ð¿Ñ‹Ñ‚ÐºÐ° Ñ Ð¿ÐµÑ€ÐµÐ¿Ð¾Ð»ÑƒÑ‡ÐµÐ½Ð¸ÐµÐ¼ Ñ‚Ð¾ÐºÐµÐ½Ð° Ð¸Ð· Ñ…Ñ€Ð°Ð½Ð¸Ð»Ð¸Ñ‰Ð°
    // 502,504 - Ð¾Ð´Ð½Ð¾ÐºÑ€Ð°Ñ‚Ð½Ñ‹Ð¹ Ð¿Ð¾Ð²Ñ‚Ð¾Ñ€
    // return false; Ð¿Ñ€ÐµÑ€Ñ‹Ð²Ð°ÐµÑ‚ Ð´Ð°Ð»ÑŒÐ½ÐµÐ¹ÑˆÑƒÑŽ Ð»Ð¾Ð³Ð¸ÐºÑƒ Ð¾Ð±Ñ€Ð°Ð±Ð¾Ñ‚ÐºÐ¸
});

$api->callbacks->on('query.response.fail', function($query, $code) {
    // Ð²Ñ‹Ð·Ñ‹Ð²Ð°ÐµÑ‚ÑÑ Ð¿Ð¾ÑÐ»Ðµ Ð½ÐµÑƒÐ´Ð°Ñ‡Ð½Ð¾Ð³Ð¾ Ð²Ñ‹Ð¿Ð¾Ð»Ð½ÐµÐ½Ð¸Ñ Ð·Ð°Ð¿Ñ€Ð¾ÑÐ°
    // Ð²ÑÐµ ÐºÐ¾Ð´Ñ‹ Ð¾Ñ‚Ð²ÐµÑ‚Ð° ÐºÑ€Ð¾Ð¼Ðµ 200,204
    if ($code === 0) {
        echo 'Error: '.$query->response->getError()."\n\n";
    } else {
        echo "Response:\n".$query->endDate().' - ['.$code.'] '.$query->response->getData()."\n\n";
    }
});

$api->callbacks->on('query.response.after', function($query, $code) {
    // Ð²Ñ‹Ð·Ñ‹Ð²Ð°ÐµÑ‚ÑÑ Ð²ÑÐµÐ³Ð´Ð° Ð¿Ð¾ÑÐ»Ðµ Ð²Ñ‹Ð¿Ð¾Ð»Ð½ÐµÐ½Ð¸Ñ Ð·Ð°Ð¿Ñ€Ð¾ÑÐ°
    if ($code === 0) {
        echo 'Error: '.$query->response->getError()."\n\n";
    } else {
        echo "Response:\n".$query->endDate().' - ['.$code.'] '.$query->response->getData()."\n\n";
    }
});

$api->callbacks->on('oauth.token.fetch', function($oauth, $query, $response) {
    // Ð²Ñ‹Ð·Ñ‹Ð²Ð°ÐµÑ‚ÑÑ Ð¿Ð¾ÑÐ»Ðµ Ð¸Ð·Ð²Ð»ÐµÑ‡ÐµÐ½Ð¸Ñ Ñ‚Ð¾ÐºÐµÐ½Ð°
});

$api->callbacks->on('oauth.token.refresh', function($oauth, $query, $response) {
    // Ð²Ñ‹Ð·Ñ‹Ð²Ð°ÐµÑ‚ÑÑ Ð¿Ð¾ÑÐ»Ðµ Ð¾Ð±Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ñ Ñ‚Ð¾ÐºÐµÐ½Ð°
});

$api->callbacks->on('oauth.token.refresh.error', function($exc, $query = null, $response = null) {
    // Ð²Ñ‹Ð·Ñ‹Ð²Ð°ÐµÑ‚ÑÑ Ð¿Ð¾ÑÐ»Ðµ Ð½ÐµÑƒÐ´Ð°Ñ‡Ð½Ð¾Ð³Ð¾ Ð¾Ð±Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ñ Ñ‚Ð¾ÐºÐµÐ½Ð°
});
```
### ðŸ” ÐŸÐµÑ€Ð²Ð¸Ñ‡Ð½Ð¾Ðµ Ð¿Ð¾Ð»ÑƒÑ‡ÐµÐ½Ð¸Ðµ OAuth-Ñ‚Ð¾ÐºÐµÐ½Ð° 
```php
$api->oauth->fetchToken($code); // Ñ‚Ð¾ÐºÐµÐ½ ÑÐ¾Ñ…Ñ€Ð°Ð½Ð¸Ñ‚ÑÑ Ð² Ð²Ñ‹Ð±Ñ€Ð°Ð½Ð½Ð¾Ð¼ storage
```
### ðŸ“¥ Ð Ð°Ð±Ð¾Ñ‚Ð° Ñ ÑÑƒÑ‰Ð½Ð¾ÑÑ‚ÑÐ¼Ð¸  
ÐŸÑ€Ð¾Ð¸Ð·Ð²Ð¾Ð´Ð¸Ñ‚ÑÑ Ñ‡ÐµÑ€ÐµÐ· ÑÐµÑ€Ð²Ð¸ÑÑ‹:
```php
// Ð¿Ð¾Ð»ÑƒÑ‡ÐµÐ½Ð¸Ðµ ÑÐºÐ·ÐµÐ¼Ð¿Ð»ÑÑ€Ð° ÑÐµÑ€Ð²Ð¸ÑÐ°
$service = $api->account();
$api->users();
$api->customFields($entity_type);
$api->pipelines();
$api->pipelineStatuses($pipeline_id);
$api->leads();
$api->contacts();
$api->companies();
$api->links();
$api->tasks();
$api->notes($entity_type);
$api->events();
$api->webhooks();
```
Ð£ÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ° Ð¿Ð°Ñ€Ð°Ð¼ÐµÑ‚Ñ€Ð¾Ð²
```php
$service->maxPageRows($value);
$service->orderBy($field, $direction = 'asc')
$service->with($values);
$service->setQueryArg($key, $value);
$service->setQueryArgs($args = []);

```
ÐŸÐ¾Ð»ÑƒÑ‡ÐµÐ½Ð¸Ðµ ÑÑƒÑ‰Ð½Ð¾ÑÑ‚ÐµÐ¹
```php
$model = $service->find($elem_id, $with = []);
$collection = $service->get($with = null);
$paginate = $service->paginate($with = null);
$paginate = $service->filter($conditions, $with = []);
$paginate = $service->search($phrase, $with = []);

```
Ð¡Ð¾Ð·Ð´Ð°Ð½Ð¸Ðµ/Ð¾Ð±Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ðµ ÑÑƒÑ‰Ð½Ð¾Ñ‚ÐµÐ¹ Ñ‡ÐµÑ€ÐµÐ· ÑÑ‹Ñ€Ñ‹Ðµ Ð´Ð°Ð½Ð½Ñ‹Ðµ  
$raw_data Ð¼Ð¾Ð¶ÐµÑ‚ Ð±Ñ‹Ñ‚ÑŒ Ð¾Ð±ÑŠÐµÐºÑ‚Ð¾Ð¼ Ð¸Ð»Ð¸ Ð¼Ð°ÑÑÐ¸Ð²Ð¾Ð¼ Ð¾Ð±ÑŠÐµÐºÑ‚Ð¾Ð²  
ÐÐ° Ð¿Ñ€Ð°ÐºÑ‚Ð¸ÐºÐµ Ð½Ðµ Ð¿Ñ€Ð¸Ð¼ÐµÐ½ÑÐµÑ‚ÑÑ, Ñ‚Ð°Ðº ÐºÐ°Ðº Ð´ÐµÐ¹ÑÑ‚Ð²Ð¸Ðµ Ð¿Ñ€Ð¾Ð¸Ð·Ð²Ð¾Ð´Ð¸Ñ‚ÑÑ Ñ‡ÐµÑ€ÐµÐ· Ð¼Ð¾Ð´ÐµÐ»ÑŒ
```php
$raw_response = $service->add($raw_data);
$raw_response = $service->update($raw_data);
```
#### ÐœÐ¾Ð´ÐµÐ»ÑŒ ÑÑƒÑ‰Ð½Ð¾ÑÑ‚Ð¸  
ÐŸÐ¾Ð»Ñ Ð¼Ð¾Ð´ÐµÐ»ÐµÐ¹ Ð´Ð¸Ð½Ð°Ð¼Ð¸Ñ‡ÐµÑÐºÐ¸Ðµ, Ñ€ÐµÐ°Ð»Ð¸Ð·Ð¾Ð²Ð°Ð½Ñ‹ Ñ‡ÐµÑ€ÐµÐ· Ð³ÐµÑ‚Ñ‚ÐµÑ€Ñ‹ Ð¸ ÑÐµÑ‚Ñ‚ÐµÑ€Ñ‹
```php
$model = $service->create(['field1' => 'value', 'field2' => 'value', ...]);
// Ð¸Ð»Ð¸ 
$model = $service->find(123567);

$model->name = 'Name';
$model->price = 100;
$model->save(); // ÑÐ¾Ð·Ð´Ð°Ð½Ð¸Ðµ Ð¸Ð»Ð¸ Ð¾Ð±Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ðµ ÑÑƒÑ‰Ð½Ð¾ÑÑ‚Ð¸ Ð¿Ð¾Ð´ ÐºÐ°Ð¿Ð¾Ñ‚Ð¾Ð¼
$model->toArray(); 
```
#### ÐšÐ¾Ð»Ð»ÐµÐºÑ†Ð¸Ñ ÑÑƒÑ‰Ð½Ð¾ÑÑ‚ÐµÐ¹  
```php
$models = $service->createCollection([
    ['field1' => 'value', 'field2' => 'value', ...],
    ['field1' => 'value', 'field2' => 'value', ...],
]);
// Ð¸Ð»Ð¸ 
$models = $service->get();

foreach($models as $model) {
    $model->attachTag('AmoV4');
}
$models->save(); // Ð¼Ð°ÑÑÐ¾Ð²Ð¾Ðµ ÑÐ¾Ð·Ð´Ð°Ð½Ð¸Ðµ Ð¸Ð»Ð¸ Ð¾Ð±Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ðµ ÑÑƒÑ‰Ð½Ð¾ÑÑ‚ÐµÐ¹ Ð¿Ð¾Ð´ ÐºÐ°Ð¿Ð¾Ñ‚Ð¾Ð¼
$models->toArray(); 
```
#### ÐŸÐ¾Ð»ÑƒÑ‡ÐµÐ½Ð¸Ðµ ÑÑƒÑ‰Ð½Ð¾ÑÑ‚ÐµÐ¹ Ð¿Ð¾ ID  
```php
$lead = $api->leads()->find(30013961);
$contact = $api->contacts()->find(45968927);
$company = $api->companies()->find(55968943);

$leads = $api->leads()->find([30013961,30013962,30013963]);
```
#### ÐŸÐ¾ÑÑ‚Ñ€Ð°Ð½Ð¸Ñ‡Ð½Ð¾Ðµ Ð¿Ð¾Ð»ÑƒÑ‡ÐµÐ½Ð¸Ðµ 
```php
$paginate = $api->leads()->paginate();
$paginate->maxPages(10); // Ð¼Ð°ÐºÑÐ¸Ð¼Ð°Ð»ÑŒÐ½Ð¾Ðµ ÐºÐ¾Ð»-Ð²Ð¾ ÑÑ‚Ñ€Ð°Ð½Ð¸Ñ†
$paginate->maxRows(100); // Ð¼Ð°ÐºÑÐ¸Ð¼Ð°Ð»ÑŒÐ½Ð¾Ðµ ÐºÐ¾Ð»-Ð²Ð¾ ÑÑƒÑ‰Ð½Ð¾ÑÑ‚ÐµÐ¹ Ð½Ð° ÑÑ‚Ñ€Ð°Ð½Ð¸Ñ†Ðµ

do {
    echo "\nPage ".$paginate->page."\n";
    $leads = $paginate->fetchPage();
    print_r($leads); // collection
} while(
    $paginate->next();
);

// Ð¸Ð»Ð¸ Ñ‚Ð°Ðº
foreach($paginate as $page_num=>$leads) {
    echo "\nPage ".$page_num."\n";
    print_r($leads); // collection
}
```
#### Ð¤Ð¸Ð»ÑŒÑ‚Ñ€Ð°Ñ†Ð¸Ñ ÑÑƒÑ‰Ð½Ð¾ÑÑ‚ÐµÐ¹
```php
$paginate = $api->leads()->filter([
    'price' => ['from' => 0, 'to' => 100500]
]);
foreach($paginate as $page_num=>$leads) {
    echo "\nPage ".$page_num."\n";
    print_r($leads); // collection
}
```
#### ÐŸÐ¾Ð¸ÑÐº ÑÑƒÑ‰Ð½Ð¾ÑÑ‚ÐµÐ¹
```php
$leads = $service->searchByCustomField(string $query, string $field, int $page_limit = 0, array $with = []);
$contacts = $service->searchByPhone(string $phone, int $page_limit = 0, array $with = []);
$contacts = $service->searchByEmail(string $email, int $page_limit = 0, array $with = []);
$companies = $service->searchByName(string $name, int $page_limit = 0, array $with = []);

$paginate = $leads->search('query', ['source_id','source']);
```
#### ÐÐºÐºÐ°ÑƒÐ½Ñ‚
```php
$account = $api->account()->get();
// Ð¸Ð»Ð¸
$account = $api->account;
// Ð¸Ð»Ð¸ Ð¸Ð· ÐºÐµÑˆÐ°
$account = $api->cache->account();

// Ð¼Ð¾Ð´ÐµÐ»ÑŒ Ð°ÐºÐºÐ°ÑƒÐ½Ñ‚Ð°
echo $account->id;
echo $account->name;

$userGroups = $account->userGroups; // collection
$taskTypes = $account->taskTypes; // collection

// Ð¸Ð»Ð¸ Ð¸Ð· ÐºÐµÑˆÐ°
$userGroups = $api->cache->userGroups();
$taskTypes = $api->cache->taskTypes();
$eventTypes = $api->cache->eventTypes($lang = null); // Ñ‚ÐµÐºÑƒÑ‰Ð¸Ð¹ ÑÐ·Ñ‹Ðº Ð¿Ð¾ ÑƒÐ¼Ð¾Ð»Ñ‡Ð°Ð½Ð¸ÑŽ
```
#### ÐŸÐ¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»Ð¸ Ð°ÐºÐºÐ°ÑƒÐ½Ñ‚Ð°
```php
$users = $api->users()->get();
// Ð¸Ð»Ð¸ Ð¸Ð· ÐºÐµÑˆÐ°
$users = $api->cache->users();
// Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÑŒ Ð¿Ð¾ id
$user = $api->cache->user(128737);
```
#### Ð’Ð¾Ñ€Ð¾Ð½ÐºÐ¸ ÑÐ´ÐµÐ»Ð¾Ðº
```php
$pipelines = $api->pipelines()->get();
$pipeline = $api->pipelines()->find($pipeline_id);
// Ð¸Ð»Ð¸ Ð¸Ð· ÐºÐµÑˆÐ°
$pipelines = $api->cache->pipelines();
$pipeline = $api->cache->pipeline($pipeline_id);
// Ð¸Ð»Ð¸ Ð½Ð¾Ð²Ð°Ñ Ð²Ð¾Ñ€Ð¾Ð½ÐºÐ°
$pipeline = $api->pipelines()->create(['name' => 'Ð ÐµÐºÐ»Ð°Ð¼Ð°Ñ†Ð¸Ð¸']);

$pipeline->sort = 20;
$pipeline->is_main = false;
$pipeline->is_unsorted_on = false;
$pipeline->_embedded = [];
$pipeline->save();

// ÑÑ‚Ð°Ð¿Ñ‹ Ð²Ð¾Ñ€Ð¾Ð½ÐºÐ¸
$statuses = $pipeline->statuses(); // collection
// ÑƒÐ´Ð°Ð»ÐµÐ½Ð¸Ðµ Ð²Ð¾Ñ€Ð¾Ð½ÐºÐ¸
$pipeline->delete();
```
#### Ð­Ñ‚Ð°Ð¿Ñ‹ Ð²Ð¾Ñ€Ð¾Ð½Ð¾Ðº
```php
$statuses = $api->pipelineStatuses($pipeline_id)->with(['descriptions'])->get();
$status = $api->pipelineStatuses($pipeline_id)->find($status_id, ['descriptions']);
// Ð¸Ð»Ð¸ Ð½Ð¾Ð²Ñ‹Ð¹ ÑÑ‚Ð°Ð¿
$status = $api->pipelineStatuses($pipeline_id)->create(['name' => 'Ð”Ð¾Ð³Ð¾Ð²Ð¾Ñ€ Ð¿Ð¾Ð´Ð¿Ð¸ÑÐ°Ð½']);

$status->sort = 50;
$status->save();

// ÑƒÐ´Ð°Ð»ÐµÐ½Ð¸Ðµ ÑÑ‚Ð°Ð¿Ð°
$status->delete();
```
#### ÐšÐ°ÑÑ‚Ð¾Ð¼Ð½Ñ‹Ðµ Ð¿Ð¾Ð»Ñ Ð°ÐºÐºÐ°ÑƒÐ½Ñ‚Ð°
```php
$service = $api->customFields('contacts');
$service = $api->customFields('catalogs', $catalog_id);
$service->maxPageRows(10);
$service->orderBy('sort', 'desc');

// Ð¿Ð¾Ð»ÑƒÑ‡ÐµÐ½Ð¸Ðµ ÐºÐ¾Ð»Ð»ÐµÐºÑ†Ð¸Ð¸
$cfields = $service->get();
// Ð¸Ð»Ð¸ Ð¸Ð· ÐºÐµÑˆÐ°
$cfields = $api->cache->customFields('contacts');
$cfields = $api->cache->customFields('catalogs', $catalog_id);
```
Ð¡Ð¾Ð·Ð´Ð°Ð½Ð¸Ðµ Ð¿Ð¾Ð»Ñ
```php
$service = $api->customFields('contacts');
$cf = $service->create(['name' => 'Ð’Ð°Ñ€Ð¸Ð°Ð½Ñ‚Ñ‹ Ð¾Ð¿Ð»Ð°Ñ‚Ñ‹']);
$cf->type = 'multiselect';
$cf->enums = [
    ['value' => 'ÐžÐ½Ð»Ð°Ð¹Ð½', 'sort' => 0],
    ['value' => 'ÐŸÑ€Ð¸ Ð¿Ð¾Ð»ÑƒÑ‡ÐµÐ½Ð¸Ð¸', 'sort' => 1],
    ['value' => 'Ð¡Ð‘ÐŸ', 'sort' => 2]
];
$cf->save();
```
#### ÐšÐ°ÑÑ‚Ð¾Ð¼Ð½Ñ‹Ðµ ÑÑƒÑ‰Ð½Ð¾ÑÑ‚Ð¸
```php
$lead = $api->leads()->find($lead_id);

$cf = $lead->cf('Ð’Ð°Ñ€Ð¸Ð°Ð½Ñ‚Ñ‹ Ð¾Ð¿Ð»Ð°Ñ‚Ñ‹');
$cf->reset();
$cf->setValues(['ÐžÐ½Ð»Ð°Ð¹Ð½','ÐŸÑ€Ð¸ Ð¿Ð¾Ð»ÑƒÑ‡ÐµÐ½Ð¸Ð¸']);
$cf->setEnums([845234,945431]);
$values = $cf->getValues();

// Ð¿Ð¾Ð»Ðµ Ð¿Ð¾ Ð½Ð°Ð·Ð²Ð°Ð½Ð¸ÑŽ
$cf = $lead->cf('Ð“Ð¾Ñ€Ð¾Ð´');
// Ð¿Ð¾Ð»Ðµ Ð¿Ð¾ id
$cf = $lead->cf(3745829);

$cf->setValue('ÐœÐ¾ÑÐºÐ²Ð°');
$cf->setEnum(546710);
$value = $cf->getValue();

$field = $cf->field;
$enum_values = $field->getEnums();
$enum_ids = $field->getEnumIds();
$values = $field->getValues();
$bool = $field->hasEnum(568345);
$bool = $field->hasValue('Ð§ÐµÐ±Ð¾ÐºÑÐ°Ñ€Ñ‹');

$cf = $lead->cf()->byName('Ð“Ð¾Ñ€Ð¾Ð´');
$cf = $lead->cf()->byId(3745829);
$cf = $lead->cf()->byCode('PHONE');
$cf = $lead->cf()->byType('radiobutton');

$cfields = $lead->cf()->all();
foreach($cfs as $cf) {
    print_r($cf->getValue());
    echo "\n";
}
```
#### Ð¡Ð´ÐµÐ»ÐºÐ¸
```php
$leads = $api->leads()->get();
$leads = $api->leads;
$leads = $api->leads()->with(['source_id','source']))->get();
$leads = $api->leads()->searchByCustomField('ÐœÐ¾ÑÐºÐ²Ð°', 'Ð“Ð¾Ñ€Ð¾Ð´', 1); // 1 page (250 rows max)
$leads = $api->leads()->searchByName('Ð Ð°Ð·Ñ€Ð°Ð±Ð¾Ñ‚ÐºÐ° ÐŸÐž', 1, ['source_id','source']); // 1 page with source

$paginate = $api->leads()
                ->orderBy('updated_at', 'desc')
                ->with(['source_id','source','loss_reason'])
                ->paginate();

$paginate = $api->leads()->filter($conditions = [],  $with = []);
$paginate = $api->leads()->search('VIP');

$lead = $api->leads()->find($lead_id);
$lead = $api->leads()->find($lead_ids, ['source_id','source']);
$lead = $api->leads()->create(['name' => 'ÐÐ¾Ð²Ð°Ñ ÑÐ´ÐµÐ»ÐºÐ°']);

$lead->price = 100;
$lead->status_id = 21776227;
$lead->cf('ÐŸÑ€Ð¸Ð¾Ñ€Ð¸Ñ‚ÐµÑ‚')->setValue('Ð’Ñ‹ÑÐ¾ÐºÐ¸Ð¹'); // set value name by cf name
$lead->cf(123678)->setEnum(83565); // set enum id by cf id

$lead->attachTag('Tag1');
$lead->attachTag(['name' => 'Ð¦Ð²ÐµÑ‚Ð½Ð¾Ð¹', 'color' => 'FF8F92']);
$lead->detachTag('Tag3');
$tags = $lead->getTags();

// replace all existing tags
$lead->setTags($tags); // ids or names
$lead->resetTags(); // replace with none

$paginate = $lead->getTasks($filter = []);
$tasks = $lead->getTasks($filter = [])->fetchAll();
$task = $lead->findTask($task_id);
$task = $lead->createTask($type = 1);

$paginate = $lead->getNotes($filter = []);
$notes = $lead->getNotes($filter = [])->fetchAll();
$note = $lead->findTask($task_id);
$note = $lead->createNote($type = 'common');

```

