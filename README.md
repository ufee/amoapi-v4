# ðŸš€ amoCRM/Kommo PHP API (v4) Client

ÐŸÐ¾Ð´Ð´ÐµÑ€Ð¶Ð¸Ð²Ð°ÐµÑ‚ OAuth 2.0, ÐºÑÑˆÐ¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ðµ, Ð¿Ð°Ð³Ð¸Ð½Ð°Ñ†Ð¸ÑŽ, ÑÐ¾Ð±Ñ‹Ñ‚Ð¸Ñ, Ð°Ð²Ñ‚Ð¾Ð¼Ð°Ñ‚Ð¸Ñ‡ÐµÑÐºÐ¾Ðµ Ð¾Ð±Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ðµ Ñ‚Ð¾ÐºÐµÐ½Ð¾Ð², Ð¾Ð±Ñ€Ð°Ð±Ð¾Ñ‚ÐºÑƒ Ð¾ÑˆÐ¸Ð±Ð¾Ðº Ð¸ Ñ€Ð°Ð±Ð¾Ñ‚Ñƒ Ñ Ð»ÑŽÐ±Ñ‹Ð¼Ð¸ ÑÑƒÑ‰Ð½Ð¾ÑÑ‚ÑÐ¼Ð¸ (ÑÐ´ÐµÐ»ÐºÐ¸, ÐºÐ¾Ð½Ñ‚Ð°ÐºÑ‚Ñ‹, ÐºÐ¾Ð¼Ð¿Ð°Ð½Ð¸Ð¸, Ð·Ð°Ð´Ð°Ñ‡Ð¸, Ð·Ð°Ð¼ÐµÑ‚ÐºÐ¸ Ð¸ Ð´Ñ€.).

---

## âœ… Ð’Ð¾Ð·Ð¼Ð¾Ð¶Ð½Ð¾ÑÑ‚Ð¸

- âœ… ÐŸÐ´Ð´ÐµÑ€Ð¶ÐºÐ° [amoCRM/Kommo API v4](https://www.amocrm.ru/developers/content/crm_platform/platform-abilities)
- âœ… OAuth 2.0 Ñ Ð°Ð²Ñ‚Ð¾Ð¾Ð±Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸ÐµÐ¼ Ñ‚Ð¾ÐºÐµÐ½Ð¾Ð²
- âœ… Ð¥Ñ€Ð°Ð½Ð¸Ð»Ð¸Ñ‰Ðµ Ñ‚Ð¾ÐºÐµÐ½Ð¾Ð²: Ñ„Ð°Ð¹Ð»Ñ‹, Redis, MongoDB + Ð´Ð¾Ð»Ð³Ð¾ÑÑ€Ð¾Ñ‡Ð½Ñ‹Ðµ Ñ‚Ð¾ÐºÐµÐ½Ñ‹
- âœ… ÐšÑÑˆÐ¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ðµ ÑÐ¿Ñ€Ð°Ð²Ð¾Ñ‡Ð½Ð¸ÐºÐ¾Ð² Ð² Ñ„Ð°Ð¹Ð»Ð°Ñ… Ð¸ Redis: Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»Ð¸, Ð¿Ð¾Ð»Ñ, Ñ‚Ð¸Ð¿Ñ‹ Ð·Ð°Ð´Ð°Ñ‡ Ð¸ Ñ‚.Ð´.
- âœ… ÐŸÐ¾ÑÑ‚Ñ€Ð°Ð½Ð¸Ñ‡Ð½Ð¾Ðµ Ð¸Ð·Ð²Ð»ÐµÑ‡ÐµÐ½Ð¸Ðµ ÑÑƒÑ‰Ð½Ð¾ÑÑ‚ÐµÐ¹ Ñ‡ÐµÑ€ÐµÐ· `foreach` Ð¸ `do-while`
- âœ… ÐžÐ±Ñ€Ð°Ð±Ð¾Ñ‚ÐºÐ° ÑÐ¾Ð±Ñ‹Ñ‚Ð¸Ð¹ Ñ‡ÐµÑ€ÐµÐ· `callbacks`: Ð¾Ñ‚Ð»Ð°Ð´ÐºÐ°, ÐºÐ¾Ð½Ñ‚Ñ€Ð¾Ð»ÑŒ
- âœ… ÐžÐ³Ñ€Ð°Ð½Ð¸Ñ‡ÐµÐ½Ð¸Ðµ Ñ‡Ð°ÑÑ‚Ð¾Ñ‚Ñ‹ Ð·Ð°Ð¿Ñ€Ð¾ÑÐ¾Ð²
- âœ… ÐŸÐ¾Ð´Ð´ÐµÑ€Ð¶ÐºÐ° Ð¼Ð°ÑÑÐ¾Ð²Ñ‹Ñ… Ð¾Ð¿ÐµÑ€Ð°Ñ†Ð¸Ð¹
- âœ… ÐœÑƒÐ»ÑŒÑ‚Ð¸Ð°ÐºÐºÐ°ÑƒÐ½Ñ‚Ð½Ð¾ÑÑ‚ÑŒ

---

## ðŸ“¦ Ð£ÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ°

```bash
composer require ufee/amoapi-v4
```

## âš™ï¸ Ð‘Ñ‹ÑÑ‚Ñ€Ñ‹Ð¹ ÑÑ‚Ð°Ñ€Ñ‚

### ÐžÐ¿Ñ€ÐµÐ´ÐµÐ»ÐµÐ½Ð¸Ðµ ÐºÐ»Ð¸ÐµÐ½Ñ‚Ð°  
```php
$api = \Ufee\AmoV4\ApiClient::setInstance([
    'domain'        => 'yourdomain',           // Ð´Ð¾Ð¼ÐµÐ½ (Ð±ÐµÐ· .amocrm.ru)
    'client_id'     => '8a8135d4-31ca-47...', // ID Ð¸Ð½Ñ‚ÐµÐ³Ñ€Ð°Ñ†Ð¸Ð¸
    'client_secret' => 'zMZFNnho8FozhrDzxrbA9xuR9...',
    'redirect_uri'  => 'https://yoursite.com/auth/callback',
    'zone'          => 'ru', // Ð¸Ð»Ð¸ 'com' Ð´Ð»Ñ Kommo
]);
```

### ÐÐ°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ° Ð¿Ð°Ñ€Ð°Ð¼ÐµÑ‚Ñ€Ð¾Ð² (Ð¾Ð¿Ñ†Ð¸Ð¾Ð½Ð°Ð»ÑŒÐ½Ð¾)  
```php
$api->setParam('query_delay', 0.15);   // Ð·Ð°Ð´ÐµÑ€Ð¶ÐºÐ° Ð¼ÐµÐ¶Ð´Ñƒ Ð·Ð°Ð¿Ñ€Ð¾ÑÐ°Ð¼Ð¸ (ÑÐµÐº)
$api->setParam('query_retries', 3);    // ÐºÐ¾Ð»-Ð²Ð¾ Ð¿Ð¾Ð¿Ñ‹Ñ‚Ð¾Ðº Ð¿Ñ€Ð¸ Ð¾ÑˆÐ¸Ð±ÐºÐ°Ñ… 429
$api->setParam('lang', 'ru');          // ÑÐ·Ñ‹Ðº Ð°ÐºÐºÐ°ÑƒÐ½Ñ‚Ð°
```

### Ð¥Ñ€Ð°Ð½Ð¸Ð»Ð¸Ñ‰Ðµ Oauth 
Ð¤Ð°Ð¹Ð»Ð¾Ð²Ð¾Ðµ Ñ…Ñ€Ð°Ð½ÐµÐ½Ð¸Ðµ OAuth-Ñ‚Ð¾ÐºÐµÐ½Ð¾Ð²  
Ð˜ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐµÑ‚ÑÑ Ð¿Ð¾ ÑƒÐ¼Ð¾Ð»Ñ‡Ð°Ð½Ð¸ÑŽ: /src/Temp/{domain}/{client_id}.json
```php
$api->oauth->setStorageFiles('/path/to/oauth/storage');
```
**Ð”Ð¾Ð»Ð³Ð¾ÑÑ€Ð¾Ñ‡Ð½Ñ‹Ð¹ Ñ‚Ð¾ÐºÐµÐ½**  
```php
$api->oauth->setLongToken($long_token);
```
**Redis**  
ÐŸÐ¾Ð´Ð´ÐµÑ€Ð¶Ð¸Ð²Ð°ÐµÑ‚ÑÑ Ð±Ð¸Ð±Ð»Ð¸Ð¾Ñ‚ÐµÐºÐ° [phpredis](https://github.com/phpredis/phpredis)
```php
$redis = new \Redis();
redis->connect('127.0.0.1');
$redis->setOption(\Redis::OPT_SERIALIZER, \Redis::SERIALIZER_PHP); // Ð¸Ð»Ð¸ \Redis::SERIALIZER_IGBINARY
$redis->select(4);

$api->oauth->setStorageRedis($redis);
```
**Mongodb**  
ÐŸÐ¾Ð´Ð´ÐµÑ€Ð¶Ð¸Ð²Ð°ÐµÑ‚ÑÑ Ð±Ð¸Ð±Ð»Ð¸Ð¾Ñ‚ÐµÐºÐ° [mongo-php-library](https://github.com/mongodb/mongo-php-library)
```php
$mongo = new \MongoDB\Client('mongodb://127.0.0.1');
$collection = $mongo->selectCollection('amo', 'oauth');

$api->oauth->setStorageMongo($mongo);
```

### ÐšÐµÑˆÐ¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ðµ Ð´Ð°Ð½Ð½Ñ‹Ñ…  
ÐŸÐ¾Ð´Ð´ÐµÑ€Ð¶Ð¸Ð²Ð°ÐµÑ‚ÑÑ ÐºÐµÑˆÐ¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ðµ ÑÐ¿Ñ€Ð°Ð²Ð¾Ñ‡Ð½Ð¸ÐºÐ¾Ð² Ð¸ Ð¾Ð±Ñ‰Ð¸Ñ… Ð´Ð°Ð½Ð½Ñ‹Ñ… Ð°ÐºÐºÐ°ÑƒÐ½Ñ‚Ð°  
Ð’Ñ€ÐµÐ¼Ñ Ð¶Ð¸Ð·Ð½Ð¸ Ð´Ð»Ñ ÐºÑÑˆÐ° / Ð¿Ð¾ ÑƒÐ¼Ð¾Ð»Ñ‡Ð°Ð½Ð¸ÑŽ
```php
$api->cache->setTtl([
    'account'      => 60, // 3600
    'users'        => 60, // 1800
    'userGroups'   => 60, // 3600
    'customFields' => 60, // 1800
    'taskTypes'    => 60, // 3600
    'eventTypes'   => 60  // 86400
]);
```
Ð¤Ð°Ð¹Ð»Ð¾Ð²Ð¾Ðµ Ñ…Ñ€Ð°Ð½ÐµÐ½Ð¸Ðµ OAuth-Ñ‚Ð¾ÐºÐµÐ½Ð¾Ð²  
Ð˜ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐµÑ‚ÑÑ Ð¿Ð¾ ÑƒÐ¼Ð¾Ð»Ñ‡Ð°Ð½Ð¸ÑŽ: /src/Temp/{domain}/{client_id}.{key}.cache
```php
$api->cache->setStorageFiles('/path/to/cache/storage', [
    'serialize'   => 'igbinary_serialize', // Ñ€ÐµÐºÐ¾Ð¼ÐµÐ½Ð´ÑƒÐµÑ‚ÑÑ Ð²Ð¼ÐµÑÑ‚Ð¾ serialize
    'unserialize' => 'igbinary_unserialize' // Ñ€ÐµÐºÐ¾Ð¼ÐµÐ½Ð´ÑƒÐµÑ‚ÑÑ Ð²Ð¼ÐµÑÑ‚Ð¾ unserialize
]);
```
**Redis**  
ÐŸÐ¾Ð´Ð´ÐµÑ€Ð¶Ð¸Ð²Ð°ÐµÑ‚ÑÑ Ð±Ð¸Ð±Ð»Ð¸Ð¾Ñ‚ÐµÐºÐ° [phpredis](https://github.com/phpredis/phpredis)
```php
$redis = new \Redis();
redis->connect('127.0.0.1');
$redis->setOption(\Redis::OPT_SERIALIZER, \Redis::SERIALIZER_PHP); // Ð¸Ð»Ð¸ \Redis::SERIALIZER_IGBINARY
$redis->select(4);

$api->cache->setStorageRedis($redis);
```

### ðŸ”” Ð¡Ð¾Ð±Ñ‹Ñ‚Ð¸Ñ (Callbacks)  
ÐœÐ¾Ð½Ð¸Ñ‚Ð¾Ñ€Ð¸Ð½Ð³ Ð·Ð°Ð¿Ñ€Ð¾ÑÐ¾Ð², Ð»Ð¾Ð³Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ðµ, Ð¾Ð±Ñ€Ð°Ð±Ð¾Ñ‚ÐºÐ° Ð¾ÑˆÐ¸Ð±Ð¾Ðº, ÐºÐ¾Ð½Ñ‚Ñ€Ð¾Ð»ÑŒ  
```php
$api->callbacks->on($event, function($payload) {
   // Ð¿Ð¾Ð´Ð¿Ð¸ÑÐºÐ° Ð½Ð° ÑÐ¾Ð±Ñ‹Ñ‚Ð¸Ñ
});
```
```php
$api->callbacks->off($event, function($payload) {
   // Ð¾Ñ‚Ð¿Ð¸ÑÐºÐ° Ð¾Ñ‚ ÑÐ¾Ð±Ñ‹Ñ‚Ð¸Ð¹
});
```
ÐŸÑ€Ð¸Ð¼ÐµÑ€Ñ‹ ÑÐ¾Ð±Ñ‹Ñ‚Ð¸Ð¹  
```php
$api->callbacks->off('query.delay')->on('query.delay', function($query) {
    // ÐºÐ°ÑÑ‚Ð¾Ð¼Ð½Ð°Ñ Ð»Ð¾Ð³Ð¸ÐºÐ° Ð·Ð°Ð´ÐµÑ€Ð¶ÐµÐº Ð¼ÐµÐ¶Ð´Ñƒ Ð·Ð°Ð¿Ñ€Ð¾ÑÐ°Ð¼Ð¸
});

$api->callbacks->on('query.response.before', function($query) {
    // Ð²Ñ‹Ð·Ñ‹Ð²Ð°ÐµÑ‚ÑÑ Ð¿ÐµÑ€ÐµÐ´ Ð²Ñ‹Ð¿Ð¾Ð»Ð½ÐµÐ½Ð¸ÐµÐ¼ Ð·Ð°Ð¿Ñ€Ð¾ÑÐ°
});

$api->callbacks->on('query.response.code', function($code, $query) {
    // Ð²Ñ‹Ð·Ñ‹Ð²Ð°ÐµÑ‚ÑÑ Ð¿Ð¾ÑÐ»Ðµ Ð²Ñ‹Ð¿Ð¾Ð»Ð½ÐµÐ½Ð¸Ñ Ð·Ð°Ð¿Ñ€Ð¾ÑÐ°
});

$api->callbacks->on('query.response.fail', function($query, $code) {
    // Ð²Ñ‹Ð·Ñ‹Ð²Ð°ÐµÑ‚ÑÑ Ð¿Ð¾ÑÐ»Ðµ Ð½ÐµÑƒÐ´Ð°Ñ‡Ð½Ð¾Ð³Ð¾ Ð²Ñ‹Ð¿Ð¾Ð»Ð½ÐµÐ½Ð¸Ñ Ð·Ð°Ð¿Ñ€Ð¾ÑÐ°
});

$api->callbacks->on('query.response.after', function($query, $code) {
    // Ð²Ñ‹Ð·Ñ‹Ð²Ð°ÐµÑ‚ÑÑ Ð¿Ð¾ÑÐ»Ðµ Ð²Ñ‹Ð¿Ð¾Ð»Ð½ÐµÐ½Ð¸Ñ Ð·Ð°Ð¿Ñ€Ð¾ÑÐ°
});

$api->callbacks->on('oauth.token.fetch', function($oauth) {
    // Ð²Ñ‹Ð·Ñ‹Ð²Ð°ÐµÑ‚ÑÑ Ð¿Ð¾ÑÐ»Ðµ Ð¸Ð·Ð²Ð»ÐµÑ‡ÐµÐ½Ð¸Ñ Ñ‚Ð¾ÐºÐµÐ½Ð°
});

$api->callbacks->on('oauth.token.refresh', function($oauth) {
    // Ð²Ñ‹Ð·Ñ‹Ð²Ð°ÐµÑ‚ÑÑ Ð¿Ð¾ÑÐ»Ðµ Ð¾Ð±Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ñ Ñ‚Ð¾ÐºÐµÐ½Ð°
});

$api->callbacks->on('oauth.token.refresh.error', function($oauth) {
    // Ð²Ñ‹Ð·Ñ‹Ð²Ð°ÐµÑ‚ÑÑ Ð¿Ð¾ÑÐ»Ðµ Ð½ÐµÑƒÐ´Ð°Ñ‡Ð½Ð¾Ð³Ð¾ Ð¾Ð±Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ñ Ñ‚Ð¾ÐºÐµÐ½Ð°
});
```
### ðŸ” ÐŸÐµÑ€Ð²Ð¸Ñ‡Ð½Ð¾Ðµ Ð¿Ð¾Ð»ÑƒÑ‡ÐµÐ½Ð¸Ðµ OAuth-Ñ‚Ð¾ÐºÐµÐ½Ð° 
```php
$oauth = $api->oauth->fetchToken($code); // ÑÐ¾Ñ…Ñ€Ð°Ð½Ð¸Ñ‚ÑÑ Ð² Ð²Ñ‹Ð±Ñ€Ð°Ð½Ð½Ð¾Ð¼ storage
```
### ðŸ“¥ Ð Ð°Ð±Ð¾Ñ‚Ð° Ñ ÑÑƒÑ‰Ð½Ð¾ÑÑ‚ÑÐ¼Ð¸  
ÐŸÑ€Ð¾Ð¸Ð·Ð²Ð¾Ð´Ð¸Ñ‚ÑÑ Ñ‡ÐµÑ€ÐµÐ· ÑÐµÑ€Ð²Ð¸ÑÑ‹:
```php
$service = $this->crm->account();
$service = $this->crm->users();
$service = $this->crm->customFields($entity_type);
$service = $this->crm->leads();
$service = $this->crm->contacts();
$service = $this->crm->companies();
$service = $this->crm->links();
$service = $this->crm->tasks();
$service = $this->crm->notes();
$service = $this->crm->events();
$service = $this->crm->webhooks();
```
#### ÐŸÐ¾Ð»ÑƒÑ‡ÐµÐ½Ð¸Ðµ ÑÑƒÑ‰Ð½Ð¾ÑÑ‚ÐµÐ¹ Ð¿Ð¾ ID  
```php
$lead = $api->leads()->find(30013961);
$contact = $api->contacts()->find(45968927);
$company = $api->companies()->find(55968943);

$leads = $api->leads()->find([30013961,30013962,30013963]);
```
#### ÐŸÐ¾ÑÑ‚Ñ€Ð°Ð½Ð¸Ñ‡Ð½Ð¾Ðµ Ð¿Ð¾Ð»ÑƒÑ‡ÐµÐ½Ð¸Ðµ 
```php
$paginate = $api->leads()->paginate();
$paginate->maxPages(10); // Ð¼Ð°ÐºÑÐ¸Ð¼Ð°Ð»ÑŒÐ½Ð¾Ðµ ÐºÐ¾Ð»-Ð²Ð¾ ÑÑ‚Ñ€Ð°Ð½Ð¸Ñ†
$paginate->maxRows(100); // Ð¼Ð°ÐºÑÐ¸Ð¼Ð°Ð»ÑŒÐ½Ð¾Ðµ ÐºÐ¾Ð»-Ð²Ð¾ ÑÑƒÑ‰Ð½Ð¾ÑÑ‚ÐµÐ¹ Ð½Ð° ÑÑ‚Ñ€Ð°Ð½Ð¸Ñ†Ðµ

do {
    echo "\nPage ".$paginate->page."\n";
    $leads = $paginate->fetchPage();
    print_r($leads);
} while(
    $paginate->next()
);

// Ð¸Ð»Ð¸ Ñ‚Ð°Ðº
foreach($paginate as $page_num=>$leads) {
    echo "\nPage ".$page_num."\n";
	print_r($leads);
}
```


