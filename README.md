# üöÄ amoCRM/Kommo PHP API (v4) Client

–ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç OAuth 2.0, –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ, –ø–∞–≥–∏–Ω–∞—Ü–∏—é, —Å–æ–±—ã—Ç–∏—è, –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ç–æ–∫–µ–Ω–æ–≤, –æ–±—Ä–∞–±–æ—Ç–∫—É –æ—à–∏–±–æ–∫ –∏ —Ä–∞–±–æ—Ç—É —Å –ª—é–±—ã–º–∏ —Å—É—â–Ω–æ—Å—Ç—è–º–∏ (—Å–¥–µ–ª–∫–∏, –∫–æ–Ω—Ç–∞–∫—Ç—ã, –∫–æ–º–ø–∞–Ω–∏–∏, –∑–∞–¥–∞—á–∏, –∑–∞–º–µ—Ç–∫–∏ –∏ –¥—Ä.).

---

## ‚úÖ –í–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏

- ‚úÖ –ü–¥–¥–µ—Ä–∂–∫–∞ [amoCRM/Kommo API v4](https://www.amocrm.ru/developers/content/crm_platform/platform-abilities)
- ‚úÖ OAuth 2.0 —Å –∞–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ–º —Ç–æ–∫–µ–Ω–æ–≤
- ‚úÖ –•—Ä–∞–Ω–∏–ª–∏—â–µ —Ç–æ–∫–µ–Ω–æ–≤: —Ñ–∞–π–ª—ã, Redis, MongoDB + –¥–æ–ª–≥–æ—Å—Ä–æ—á–Ω—ã–µ —Ç–æ–∫–µ–Ω—ã
- ‚úÖ –ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–ø—Ä–∞–≤–æ—á–Ω–∏–∫–æ–≤ –≤ —Ñ–∞–π–ª–∞—Ö –∏ Redis: –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏, –ø–æ–ª—è, —Ç–∏–ø—ã –∑–∞–¥–∞—á –∏ —Ç.–¥.
- ‚úÖ –ü–æ—Å—Ç—Ä–∞–Ω–∏—á–Ω–æ–µ –∏–∑–≤–ª–µ—á–µ–Ω–∏–µ —Å—É—â–Ω–æ—Å—Ç–µ–π —á–µ—Ä–µ–∑ `foreach` –∏ `do-while`
- ‚úÖ –û–±—Ä–∞–±–æ—Ç–∫–∞ —Å–æ–±—ã—Ç–∏–π —á–µ—Ä–µ–∑ `callbacks`: –æ—Ç–ª–∞–¥–∫–∞, –∫–æ–Ω—Ç—Ä–æ–ª—å
- ‚úÖ –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ —á–∞—Å—Ç–æ—Ç—ã –∑–∞–ø—Ä–æ—Å–æ–≤
- ‚úÖ –ü–æ–¥–¥–µ—Ä–∂–∫–∞ –º–∞—Å—Å–æ–≤—ã—Ö –æ–ø–µ—Ä–∞—Ü–∏–π
- ‚úÖ –ú—É–ª—å—Ç–∏–∞–∫–∫–∞—É–Ω—Ç–Ω–æ—Å—Ç—å

---

## üì¶ –£—Å—Ç–∞–Ω–æ–≤–∫–∞

```bash
composer require ufee/amoapi-v4
```

## ‚öôÔ∏è –ë—ã—Å—Ç—Ä—ã–π —Å—Ç–∞—Ä—Ç
```php
$api = \Ufee\AmoV4\ApiClient::setInstance([...]);
$leads = $api->leads()->get();
foreach ($leads as $lead) {
    echo $lead->name . "\n";
}
```

### –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –∫–ª–∏–µ–Ω—Ç–∞  
```php
$api = \Ufee\AmoV4\ApiClient::setInstance([
    'domain'        => 'yourdomain',           // –¥–æ–º–µ–Ω (–±–µ–∑ .amocrm.ru)
    'client_id'     => '8a8135d4-31ca-47...', // ID –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏
    'client_secret' => 'zMZFNnho8FozhrDzxrbA9xuR9...',
    'redirect_uri'  => 'https://yoursite.com/auth/callback',
    'zone'          => 'ru', // –∏–ª–∏ 'com' –¥–ª—è Kommo
]);
```

### –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)  
```php
$api->setParam('query_delay', 0.15);   // –∑–∞–¥–µ—Ä–∂–∫–∞ –º–µ–∂–¥—É –∑–∞–ø—Ä–æ—Å–∞–º–∏ (—Å–µ–∫)
$api->setParam('query_retries', 3);    // –∫–æ–ª-–≤–æ –ø–æ–ø—ã—Ç–æ–∫ –ø—Ä–∏ –æ—à–∏–±–∫–∞—Ö 429
$api->setParam('lang', 'ru');          // —è–∑—ã–∫ –∞–∫–∫–∞—É–Ω—Ç–∞
```

### –•—Ä–∞–Ω–∏–ª–∏—â–µ Oauth 
–§–∞–π–ª–æ–≤–æ–µ —Ö—Ä–∞–Ω–µ–Ω–∏–µ OAuth-—Ç–æ–∫–µ–Ω–æ–≤  
–ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é: /src/Temp/{domain}/{client_id}.json
```php
$api->oauth->setStorageFiles('/path/to/oauth/storage');
```
**–î–æ–ª–≥–æ—Å—Ä–æ—á–Ω—ã–π —Ç–æ–∫–µ–Ω**  
```php
$api->oauth->setLongToken($long_token);
```
**Redis**  
–ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è –±–∏–±–ª–∏–æ—Ç–µ–∫–∞ [phpredis](https://github.com/phpredis/phpredis)
```php
$redis = new \Redis();
$redis->connect('127.0.0.1');
$redis->setOption(\Redis::OPT_SERIALIZER, \Redis::SERIALIZER_PHP); // –∏–ª–∏ \Redis::SERIALIZER_IGBINARY
$redis->select(4);

$api->oauth->setStorageRedis($redis);
```
**Mongodb**  
–ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è –±–∏–±–ª–∏–æ—Ç–µ–∫–∞ [mongo-php-library](https://github.com/mongodb/mongo-php-library)
```php
$mongo = new \MongoDB\Client('mongodb://127.0.0.1');
$collection = $mongo->selectCollection('amo', 'oauth');

$api->oauth->setStorageMongo($mongo);
```

### –ö–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö  
–ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è –∫–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–ø—Ä–∞–≤–æ—á–Ω–∏–∫–æ–≤ –∏ –æ–±—â–∏—Ö –¥–∞–Ω–Ω—ã—Ö –∞–∫–∫–∞—É–Ω—Ç–∞  
–í—Ä–µ–º—è –∂–∏–∑–Ω–∏ –¥–ª—è –∫—ç—à–∞ / –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
```php
$api->cache->setTtl([
    'account'      => 60, // 3600
    'users'        => 60, // 1800
    'pipelines'    => 60, // 3600
    'userGroups'   => 60, // 3600
    'customFields' => 60, // 1800
    'taskTypes'    => 60, // 3600
    'eventTypes'   => 60  // 86400
]);
```
–§–∞–π–ª–æ–≤–æ–µ —Ö—Ä–∞–Ω–µ–Ω–∏–µ OAuth-—Ç–æ–∫–µ–Ω–æ–≤  
–ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é: /src/Temp/{domain}/{client_id}.{key}.cache
```php
$api->cache->setStorageFiles('/path/to/cache/storage', [
    'serialize'   => 'igbinary_serialize', // —Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è –≤–º–µ—Å—Ç–æ serialize
    'unserialize' => 'igbinary_unserialize' // —Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è –≤–º–µ—Å—Ç–æ unserialize
]);
```
**Redis**  
–ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è –±–∏–±–ª–∏–æ—Ç–µ–∫–∞ [phpredis](https://github.com/phpredis/phpredis)
```php
$redis = new \Redis();
redis->connect('127.0.0.1');
$redis->setOption(\Redis::OPT_SERIALIZER, \Redis::SERIALIZER_PHP); // –∏–ª–∏ \Redis::SERIALIZER_IGBINARY
$redis->select(4);

$api->cache->setStorageRedis($redis);
```

### üîî –°–æ–±—ã—Ç–∏—è (Callbacks)  
–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –∑–∞–ø—Ä–æ—Å–æ–≤, –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ, –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫, –∫–æ–Ω—Ç—Ä–æ–ª—å  
```php
$api->callbacks->on($event, function($payload) {
   // –ø–æ–¥–ø–∏—Å–∫–∞ –Ω–∞ —Å–æ–±—ã—Ç–∏—è
});
```
```php
$api->callbacks->off($event, function($payload) {
   // –æ—Ç–ø–∏—Å–∫–∞ –æ—Ç —Å–æ–±—ã—Ç–∏–π
});
```
–ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã–µ —Å–æ–±—ã—Ç–∏—è  
–°–æ–±—ã—Ç–∏—è –ø–æ query –≤—ã–ø–æ–ª–Ω—è—é—Ç—Å—è –≤ –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ—Å—Ç–∏, —É–∫–∞–∑–∞–Ω–Ω–æ–π –Ω–∏–∂–µ
```php
$api->callbacks->off('query.delay')->on('query.delay', function($query) {
    // –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é –ø—Ä–æ–ø–∏—Å–∞–Ω–∞ –ª–æ–≥–∏–∫–∞ –∑–∞–¥–µ—Ä–∂–µ–∫ –Ω–∞ –æ—Å–Ω–æ–≤–µ $query->instance->getParam('query_delay')
    // –ø–∞—É–∑–∞ –º–µ–∂–¥—É –∑–∞–ø—Ä–æ—Å–∞–º–∏ –≤—ã—á–∏—Å–ª—è–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏
    sleep(1); // –∫–∞—Å—Ç–æ–º–Ω–∞—è –ª–æ–≥–∏–∫–∞ –∑–∞–¥–µ—Ä–∂–µ–∫ –º–µ–∂–¥—É –∑–∞–ø—Ä–æ—Å–∞–º–∏
});

$api->callbacks->on('query.request.before', function($query) {
    // –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è –ø–µ—Ä–µ–¥ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ–º –∑–∞–ø—Ä–æ—Å–∞
    echo '['.$query->method.'] '.$query->getUrl();
});

$api->callbacks->on('query.response.code', function($code, $query) {
    // –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è –ø–æ—Å–ª–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –∑–∞–ø—Ä–æ—Å–∞
    // –ø–æ—É–º–æ–ª—á–∞–Ω–∏—é –ø—Ä–∏—Å—É—Ç—Å—Ç–≤—É–µ—Ç –æ–±—Ä–∞–±–æ—Ç–∫–∞ –∫–æ–¥–æ–≤:
    // 429 - –ø–æ–≤—Ç–æ—Ä–Ω—ã–µ –ø–æ–ø—ã—Ç–∫–∏
    // 401 - –ø–æ–≤—Ç–æ—Ä–Ω–∞—è –ø–æ–ø—ã—Ç–∫–∞ —Å –ø–µ—Ä–µ–ø–æ–ª—É—á–µ–Ω–∏–µ–º —Ç–æ–∫–µ–Ω–∞ –∏–∑ —Ö—Ä–∞–Ω–∏–ª–∏—â–∞
    // 502,504 - –æ–¥–Ω–æ–∫—Ä–∞—Ç–Ω—ã–π –ø–æ–≤—Ç–æ—Ä
    // return false; –ø—Ä–µ—Ä—ã–≤–∞–µ—Ç –¥–∞–ª—å–Ω–µ–π—à—É—é –ª–æ–≥–∏–∫—É –æ–±—Ä–∞–±–æ—Ç–∫–∏
});

$api->callbacks->on('query.response.fail', function($query, $code) {
    // –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è –ø–æ—Å–ª–µ –Ω–µ—É–¥–∞—á–Ω–æ–≥–æ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –∑–∞–ø—Ä–æ—Å–∞
    // –≤—Å–µ –∫–æ–¥—ã –æ—Ç–≤–µ—Ç–∞ –∫—Ä–æ–º–µ 200,204
    if ($code === 0) {
        echo 'Error: '.$query->response->getError()."\n\n";
    } else {
        echo "Response:\n".$query->endDate().' - ['.$code.'] '.$query->response->getData()."\n\n";
    }
});

$api->callbacks->on('query.response.after', function($query, $code) {
    // –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è –≤—Å–µ–≥–¥–∞ –ø–æ—Å–ª–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –∑–∞–ø—Ä–æ—Å–∞
    if ($code === 0) {
        echo 'Error: '.$query->response->getError()."\n\n";
    } else {
        echo "Response:\n".$query->endDate().' - ['.$code.'] '.$query->response->getData()."\n\n";
    }
});

$api->callbacks->on('oauth.token.fetch', function($oauth, $query, $response) {
    // –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è –ø–æ—Å–ª–µ –∏–∑–≤–ª–µ—á–µ–Ω–∏—è —Ç–æ–∫–µ–Ω–∞
});

$api->callbacks->on('oauth.token.refresh', function($oauth, $query, $response) {
    // –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è –ø–æ—Å–ª–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Ç–æ–∫–µ–Ω–∞
});

$api->callbacks->on('oauth.token.refresh.error', function($exc, $query = null, $response = null) {
    // –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è –ø–æ—Å–ª–µ –Ω–µ—É–¥–∞—á–Ω–æ–≥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Ç–æ–∫–µ–Ω–∞
});
```
### üîê –ü–µ—Ä–≤–∏—á–Ω–æ–µ –ø–æ–ª—É—á–µ–Ω–∏–µ OAuth-—Ç–æ–∫–µ–Ω–∞ 
```php
$api->oauth->fetchToken($code); // —Ç–æ–∫–µ–Ω —Å–æ—Ö—Ä–∞–Ω–∏—Ç—Å—è –≤ –≤—ã–±—Ä–∞–Ω–Ω–æ–º storage
```
### üì• –†–∞–±–æ—Ç–∞ —Å —Å—É—â–Ω–æ—Å—Ç—è–º–∏  
–ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç—Å—è —á–µ—Ä–µ–∑ —Å–µ—Ä–≤–∏—Å—ã:
```php
// –ø–æ–ª—É—á–µ–Ω–∏–µ —ç–∫–∑–µ–º–ø–ª—è—Ä–∞ —Å–µ—Ä–≤–∏—Å–∞
$service = $api->account();
$api->users();
$api->customFields($entity_type);
$api->pipelines();
$api->pipelineStatuses($pipeline_id);
$api->leads();
$api->contacts();
$api->companies();
$api->links();
$api->tasks();
$api->notes($entity_type);
$api->events();
$api->webhooks();
```
–£—Å—Ç–∞–Ω–æ–≤–∫–∞ –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤
```php
$service->maxPageRows($value);
$service->orderBy($field, $direction = 'asc')
$service->with($values);
$service->setQueryArg($key, $value);
$service->setQueryArgs($args = []);

```
–ü–æ–ª—É—á–µ–Ω–∏–µ —Å—É—â–Ω–æ—Å—Ç–µ–π
```php
$model = $service->find($elem_id, $with = []);
$collection = $service->get($with = null);
$paginate = $service->paginate($with = null);
$paginate = $service->filter($conditions, $with = []);
$paginate = $service->search($phrase, $with = []);

```
–°–æ–∑–¥–∞–Ω–∏–µ/–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—É—â–Ω–æ—Ç–µ–π —á–µ—Ä–µ–∑ —Å—ã—Ä—ã–µ –¥–∞–Ω–Ω—ã–µ  
$raw_data –º–æ–∂–µ—Ç –±—ã—Ç—å –æ–±—ä–µ–∫—Ç–æ–º –∏–ª–∏ –º–∞—Å—Å–∏–≤–æ–º –æ–±—ä–µ–∫—Ç–æ–≤  
–ù–∞ –ø—Ä–∞–∫—Ç–∏–∫–µ –Ω–µ –ø—Ä–∏–º–µ–Ω—è–µ—Ç—Å—è, —Ç–∞–∫ –∫–∞–∫ –¥–µ–π—Å—Ç–≤–∏–µ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç—Å—è —á–µ—Ä–µ–∑ –º–æ–¥–µ–ª—å
```php
$raw_response = $service->add($raw_data);
$raw_response = $service->update($raw_data);
```
#### –ú–æ–¥–µ–ª—å —Å—É—â–Ω–æ—Å—Ç–∏  
–ü–æ–ª—è –º–æ–¥–µ–ª–µ–π –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–µ, —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω—ã —á–µ—Ä–µ–∑ –≥–µ—Ç—Ç–µ—Ä—ã –∏ —Å–µ—Ç—Ç–µ—Ä—ã
```php
$model = $service->create(['field1' => 'value', 'field2' => 'value', ...]);
// –∏–ª–∏ 
$model = $service->find(123567);

$model->name = 'Name';
$model->price = 100;
$model->save(); // —Å–æ–∑–¥–∞–Ω–∏–µ –∏–ª–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—É—â–Ω–æ—Å—Ç–∏ –ø–æ–¥ –∫–∞–ø–æ—Ç–æ–º
$model->toArray(); 
```
#### –ö–æ–ª–ª–µ–∫—Ü–∏—è —Å—É—â–Ω–æ—Å—Ç–µ–π  
```php
$models = $service->createCollection([
    ['field1' => 'value', 'field2' => 'value', ...],
    ['field1' => 'value', 'field2' => 'value', ...],
]);
// –∏–ª–∏ 
$models = $service->get();

foreach($models as $model) {
    $model->attachTag('AmoV4');
}
$models->save(); // –º–∞—Å—Å–æ–≤–æ–µ —Å–æ–∑–¥–∞–Ω–∏–µ –∏–ª–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—É—â–Ω–æ—Å—Ç–µ–π –ø–æ–¥ –∫–∞–ø–æ—Ç–æ–º
$models->toArray(); 
```
#### –ü–æ–ª—É—á–µ–Ω–∏–µ —Å—É—â–Ω–æ—Å—Ç–µ–π –ø–æ ID  
```php
$lead = $api->leads()->find(30013961);
$contact = $api->contacts()->find(45968927);
$company = $api->companies()->find(55968943);

$leads = $api->leads()->find([30013961,30013962,30013963]);
```
#### –ü–æ—Å—Ç—Ä–∞–Ω–∏—á–Ω–æ–µ –ø–æ–ª—É—á–µ–Ω–∏–µ 
```php
$paginate = $api->leads()->paginate();
$paginate->maxPages(10); // –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –∫–æ–ª-–≤–æ —Å—Ç—Ä–∞–Ω–∏—Ü
$paginate->maxRows(100); // –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –∫–æ–ª-–≤–æ —Å—É—â–Ω–æ—Å—Ç–µ–π –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ

do {
    echo "\nPage ".$paginate->page."\n";
    $leads = $paginate->fetchPage();
    print_r($leads); // collection
} while(
    $paginate->next();
);

// –∏–ª–∏ —Ç–∞–∫
foreach($paginate as $page_num=>$leads) {
    echo "\nPage ".$page_num."\n";
    print_r($leads); // collection
}
```
#### –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è —Å—É—â–Ω–æ—Å—Ç–µ–π
```php
$paginate = $api->leads()->filter([
    'price' => ['from' => 0, 'to' => 100500]
]);
foreach($paginate as $page_num=>$leads) {
    echo "\nPage ".$page_num."\n";
    print_r($leads); // collection
}
```
#### –ü–æ–∏—Å–∫ —Å—É—â–Ω–æ—Å—Ç–µ–π
```php
$leads = $service->searchByCustomField(string $query, string $field, int $page_limit = 0, array $with = []);
$contacts = $service->searchByPhone(string $phone, int $page_limit = 0, array $with = []);
$contacts = $service->searchByEmail(string $email, int $page_limit = 0, array $with = []);
$companies = $service->searchByName(string $name, int $page_limit = 0, array $with = []);

$paginate = $leads->search('query', ['source_id','source']);
```
#### –ê–∫–∫–∞—É–Ω—Ç
```php
$account = $api->account()->get();
// –∏–ª–∏
$account = $api->account;
// –∏–ª–∏ –∏–∑ –∫–µ—à–∞
$account = $api->cache->account();

// –º–æ–¥–µ–ª—å –∞–∫–∫–∞—É–Ω—Ç–∞
echo $account->id;
echo $account->name;

$userGroups = $account->userGroups; // collection
$taskTypes = $account->taskTypes; // collection

// –∏–ª–∏ –∏–∑ –∫–µ—à–∞
$userGroups = $api->cache->userGroups();
$taskTypes = $api->cache->taskTypes();
$eventTypes = $api->cache->eventTypes($lang = null); // —Ç–µ–∫—É—â–∏–π —è–∑—ã–∫ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
```
#### –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –∞–∫–∫–∞—É–Ω—Ç–∞
```php
$users = $api->users()->get();
// –∏–ª–∏ –∏–∑ –∫–µ—à–∞
$users = $api->cache->users();
// –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–æ id
$user = $api->cache->user(128737);
```
#### –í–æ—Ä–æ–Ω–∫–∏ —Å–¥–µ–ª–æ–∫
```php
$pipelines = $api->pipelines()->get();
$pipeline = $api->pipelines()->find($pipeline_id);
// –∏–ª–∏ –∏–∑ –∫–µ—à–∞
$pipelines = $api->cache->pipelines();
$pipeline = $api->cache->pipeline($pipeline_id);
// –∏–ª–∏ –Ω–æ–≤–∞—è –≤–æ—Ä–æ–Ω–∫–∞
$pipeline = $api->pipelines()->create(['name' => '–†–µ–∫–ª–∞–º–∞—Ü–∏–∏']);

$pipeline->sort = 20;
$pipeline->is_main = false;
$pipeline->is_unsorted_on = false;
$pipeline->_embedded = [];
$pipeline->save();

// —ç—Ç–∞–ø—ã –≤–æ—Ä–æ–Ω–∫–∏
$statuses = $pipeline->statuses(); // collection
// —É–¥–∞–ª–µ–Ω–∏–µ –≤–æ—Ä–æ–Ω–∫–∏
$pipeline->delete();
```
#### –≠—Ç–∞–ø—ã –≤–æ—Ä–æ–Ω–æ–∫
```php
$statuses = $api->pipelineStatuses($pipeline_id)->with(['descriptions'])->get();
$status = $api->pipelineStatuses($pipeline_id)->find($status_id, ['descriptions']);
// –∏–ª–∏ –Ω–æ–≤—ã–π —ç—Ç–∞–ø
$status = $api->pipelineStatuses($pipeline_id)->create(['name' => '–î–æ–≥–æ–≤–æ—Ä –ø–æ–¥–ø–∏—Å–∞–Ω']);

$status->sort = 50;
$status->save();

// —É–¥–∞–ª–µ–Ω–∏–µ —ç—Ç–∞–ø–∞
$status->delete();
```
#### –ö–∞—Å—Ç–æ–º–Ω—ã–µ –ø–æ–ª—è –∞–∫–∫–∞—É–Ω—Ç–∞
```php
$service = $api->customFields('contacts');
$service = $api->customFields('catalogs', $catalog_id);
$service->maxPageRows(10);
$service->orderBy('sort', 'desc');

// –ø–æ–ª—É—á–µ–Ω–∏–µ –∫–æ–ª–ª–µ–∫—Ü–∏–∏
$cfields = $service->get();
// –∏–ª–∏ –∏–∑ –∫–µ—à–∞
$cfields = $api->cache->customFields('contacts');
$cfields = $api->cache->customFields('catalogs', $catalog_id);
```
–°–æ–∑–¥–∞–Ω–∏–µ –ø–æ–ª—è
```php
$service = $api->customFields('contacts');
$cf = $service->create(['name' => '–í–∞—Ä–∏–∞–Ω—Ç—ã –æ–ø–ª–∞—Ç—ã']);
$cf->type = 'multiselect';
$cf->enums = [
    ['value' => '–û–Ω–ª–∞–π–Ω', 'sort' => 0],
    ['value' => '–ü—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏', 'sort' => 1],
    ['value' => '–°–ë–ü', 'sort' => 2]
];
$cf->save();
```
#### –ö–∞—Å—Ç–æ–º–Ω—ã–µ —Å—É—â–Ω–æ—Å—Ç–∏
```php
$lead = $api->leads()->find($lead_id);

$cf = $lead->cf('–í–∞—Ä–∏–∞–Ω—Ç—ã –æ–ø–ª–∞—Ç—ã');
$cf->reset();
$cf->setValues(['–û–Ω–ª–∞–π–Ω','–ü—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏']);
$cf->setEnums([845234,945431]);
$values = $cf->getValues();

// –ø–æ–ª–µ –ø–æ –Ω–∞–∑–≤–∞–Ω–∏—é
$cf = $lead->cf('–ì–æ—Ä–æ–¥');
// –ø–æ–ª–µ –ø–æ id
$cf = $lead->cf(3745829);

$cf->setValue('–ú–æ—Å–∫–≤–∞');
$cf->setEnum(546710);
$value = $cf->getValue();

$field = $cf->field;
$enum_values = $field->getEnums();
$enum_ids = $field->getEnumIds();
$values = $field->getValues();
$bool = $field->hasEnum(568345);
$bool = $field->hasValue('–ß–µ–±–æ–∫—Å–∞—Ä—ã');

$cf = $lead->cf()->byName('–ì–æ—Ä–æ–¥');
$cf = $lead->cf()->byId(3745829);
$cf = $lead->cf()->byCode('PHONE');
$cf = $lead->cf()->byType('radiobutton');

$cfields = $lead->cf()->all();
foreach($cfs as $cf) {
    print_r($cf->getValue());
    echo "\n";
}
```
#### –°–¥–µ–ª–∫–∏
```php
$leads = $api->leads()->get();
$leads = $api->leads;
$leads = $api->leads()->with(['source_id','source']))->get();
$leads = $api->leads()->searchByCustomField('–ú–æ—Å–∫–≤–∞', '–ì–æ—Ä–æ–¥', 1); // 1 page (250 rows max)
$leads = $api->leads()->searchByName('–†–∞–∑—Ä–∞–±–æ—Ç–∫–∞ –ü–û', 1, ['source_id','source']); // 1 page with source

$paginate = $api->leads()
                ->orderBy('updated_at', 'desc')
                ->with(['source_id','source','loss_reason'])
                ->paginate();

$paginate = $api->leads()->filter($conditions = [],  $with = []);
$paginate = $api->leads()->search('VIP');

$lead = $api->leads()->find($lead_id);
$lead = $api->leads()->find($lead_ids, ['source_id','source']);
$lead = $api->leads()->create(['name' => '–ù–æ–≤–∞—è —Å–¥–µ–ª–∫–∞']);

$lead->price = 100;
$lead->status_id = 21776227;
$lead->cf('–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç')->setValue('–í—ã—Å–æ–∫–∏–π'); // set value name by cf name
$lead->cf(123678)->setEnum(83565); // set enum id by cf id

$lead->attachTag('Tag1');
$lead->attachTag(['name' => '–¶–≤–µ—Ç–Ω–æ–π', 'color' => 'FF8F92']);
$lead->detachTag('Tag3');
$tags = $lead->getTags();

// replace all existing tags
$lead->setTags($tags); // ids or names
$lead->resetTags(); // replace with none

$paginate = $lead->getTasks($filter = []);
$tasks = $lead->getTasks($filter = [])->fetchAll();
$task = $lead->findTask($task_id);
$task = $lead->createTask($type = 1);

$paginate = $lead->getNotes($filter = []);
$notes = $lead->getNotes($filter = [])->fetchAll();
$note = $lead->findTask($task_id);
$note = $lead->createNote($type = 'common');

```

